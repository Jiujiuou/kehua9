# 第二章词云功能技术方案

## 一、需求概述

在年度报告第二章中，根据用户动态文本数据（`dynamics`）渲染词云图，展示用户年度关键词。

## 二、技术选型

### 2.1 分词引擎：jieba-wasm

**选择理由：**

- ✅ WebAssembly 版本，性能优异（比纯 JS 实现快 10-100 倍）
- ✅ 支持中文分词，准确率高
- ✅ 浏览器端运行，无需后端服务
- ✅ 体积相对较小（约 1-2MB）
- ✅ 支持自定义词典和停用词

**包名：** `jieba-wasm` 或 `@node-rs/jieba`（如果可用）

### 2.2 词云渲染库：wordcloud2.js

**选择理由：**

- ✅ 轻量级（约 50KB）
- ✅ 基于 Canvas 渲染，性能好
- ✅ API 简单易用
- ✅ 支持自定义形状、颜色、字体
- ✅ 活跃维护，兼容性好

**包名：** `wordcloud2.js` 或 `wordcloud`

**备选方案：**

- `d3-cloud`：功能强大但配置复杂，体积较大
- `react-wordcloud`：React 封装，但灵活性较低

### 2.3 Web Workers

**用途：** 在后台线程进行分词和词频统计，避免阻塞主线程

**实现方式：** 原生 Web Workers API（无需额外依赖）

## 三、整体架构设计

### 3.1 数据流程图

```
用户动态数据 (dynamics[])
    ↓
提取文本内容 (合并所有 dynamic.text)
    ↓
文本预处理 (去除特殊字符、换行等)
    ↓
Web Worker 处理
    ├─ 加载 jieba-wasm 模型
    ├─ 执行分词
    ├─ 应用停用词过滤
    └─ 统计词频
    ↓
返回词频数据 [{text: '词', value: 频次}, ...]
    ↓
词云渲染 (wordcloud2.js)
    ├─ 配置 Canvas
    ├─ 设置颜色方案（暖色调）
    ├─ 设置字体大小映射
    └─ 渲染词云图
```

### 3.2 文件结构

```
src/
├── components/
│   └── Basic/
│       └── AnnualReportCard/
│           ├── Chapter2.jsx              # 主组件
│           ├── Chapter2.module.less      # 样式文件
│           └── WordCloud/
│               ├── index.jsx              # 词云组件
│               ├── index.module.less      # 词云样式
│               └── wordCloud.worker.js   # Web Worker 脚本
├── utils/
│   └── wordCloud/
│       ├── stopWords.js                  # 停用词表
│       ├── textProcessor.js              # 文本预处理工具
│       └── colorGenerator.js            # 颜色生成器
└── public/
    └── jieba/                            # jieba-wasm 模型文件（如需要）
        ├── jieba.wasm
        └── jieba.dict.txt
```

## 四、详细实现方案

### 4.1 依赖安装

```bash
npm install wordcloud2.js jieba-wasm
# 或
npm install wordcloud @node-rs/jieba
```

**注意：** 需要确认 `jieba-wasm` 的实际包名和可用性，可能需要：

- 使用 CDN 引入
- 或使用 `@node-rs/jieba`（Rust 实现，性能更好）

### 4.2 停用词表

**位置：** `src/utils/wordCloud/stopWords.js`

```javascript
export const STOP_WORDS = [
  "的",
  "了",
  "在",
  "是",
  "我",
  "有",
  "和",
  "就",
  "不",
  "人",
  "都",
  "一",
  "个",
  "上",
  "也",
  "很",
  "到",
  "说",
  "要",
  "去",
  "你",
  "会",
  "着",
  "没有",
  "看",
  "好",
  "自己",
  "这",
  "但",
  "那",
  "她",
  "他",
  "它",
  "我们",
  "你们",
  "他们",
  "啊",
  "哦",
  "嗯",
  "吧",
  "呢",
  "吗",
  "呀",
  "啦",
  "哇",
  "嘛",
  "哈",
  "唉",
  "而",
  "且",
  "并",
  "或",
  "如果",
  "因为",
  "所以",
  "然后",
  "但是",
  "虽然",
  "即使",
  "而且",
  "或者",
  "这个",
  "那个",
  "这些",
  "那些",
  "什么",
  "怎么",
  "为什么",
  "可以",
  "可能",
  "一定",
  "真的",
  "其实",
  "觉得",
  "知道",
  "想要",
  "需要",
  "应该",
  "一定",
];
```

### 4.3 颜色生成器

**位置：** `src/utils/wordCloud/colorGenerator.js`

```javascript
const WARM_COLORS = [
  "#ff8a00",
  "#ff5252",
  "#ff4081",
  "#e040fb",
  "#7c4dff",
  "#536dfe",
  "#448aff",
  "#40c4ff",
  "#18ffff",
  "#64ffda",
  "#69f0ae",
  "#b2ff59",
  "#eeff41",
  "#ffff00",
  "#ffd740",
  "#ffab40",
];

export function randomColor() {
  return WARM_COLORS[Math.floor(Math.random() * WARM_COLORS.length)];
}

// 根据词频生成颜色（高频词使用更鲜艳的颜色）
export function getColorByFrequency(frequency, maxFrequency) {
  const ratio = frequency / maxFrequency;
  const index = Math.floor(ratio * (WARM_COLORS.length - 1));
  return WARM_COLORS[index] || WARM_COLORS[WARM_COLORS.length - 1];
}
```

### 4.4 Web Worker 实现

**位置：** `src/components/Basic/AnnualReportCard/WordCloud/wordCloud.worker.js`

**功能：**

1. 接收文本数据
2. 加载 jieba-wasm 模型
3. 执行分词
4. 过滤停用词
5. 统计词频
6. 返回词频数组

**注意：** Web Worker 中无法直接使用 npm 包，需要：

- 使用 `importScripts()` 加载外部脚本
- 或使用打包工具（如 Vite）的 Worker 支持
- 或使用 `comlink` 简化 Worker 通信

### 4.5 词云组件实现

**核心功能：**

1. 从 `dynamics` 提取文本
2. 调用 Web Worker 处理文本
3. 使用 wordcloud2.js 渲染词云
4. 处理加载状态和错误状态
5. 响应式布局适配

**关键代码结构：**

```javascript
// Chapter2.jsx
const Chapter2 = ({ userNickname = "", dynamics = [] }) => {
  const [wordCloudData, setWordCloudData] = useState([]);
  const [loading, setLoading] = useState(true);
  const canvasRef = useRef(null);

  useEffect(() => {
    // 提取文本
    const text = extractTextFromDynamics(dynamics);

    // 调用 Worker 处理
    processTextInWorker(text).then((data) => {
      setWordCloudData(data);
      setLoading(false);
    });
  }, [dynamics]);

  useEffect(() => {
    if (wordCloudData.length > 0 && canvasRef.current) {
      renderWordCloud(canvasRef.current, wordCloudData);
    }
  }, [wordCloudData]);

  return (
    <div className={styles.chapter2Content}>
      {loading ? <div>加载中...</div> : <canvas ref={canvasRef} />}
    </div>
  );
};
```

## 五、技术难点与解决方案

### 5.1 jieba-wasm 在浏览器中的使用

**问题：** jieba-wasm 可能需要 WASM 文件和字典文件

**解决方案：**

1. **方案 A：** 使用 CDN 版本（如果可用）

   ```javascript
   importScripts(
     "https://cdn.jsdelivr.net/npm/jieba-wasm@latest/dist/jieba.wasm.js"
   );
   ```

2. **方案 B：** 使用 Vite 的静态资源处理
   - 将 WASM 文件放在 `public/` 目录
   - 使用 `import.meta.url` 引用

### 5.2 Web Worker 中的模块导入

**问题：** Worker 中无法直接使用 ES6 import

**解决方案：**

1. **使用 Vite 的 Worker 支持：**

   ```javascript
   // 在组件中
   import WordCloudWorker from "./wordCloud.worker.js?worker";
   const worker = new WordCloudWorker();
   ```

2. **使用 importScripts：**

   ```javascript
   // worker 中
   importScripts("/path/to/jieba.js");
   ```

3. **使用 comlink：**
   ```bash
   npm install comlink
   ```
   简化 Worker 通信

### 5.3 词云响应式布局

**问题：** Canvas 需要根据容器大小调整

**解决方案：**

- 使用 `ResizeObserver` 监听容器大小变化
- 重新计算 Canvas 尺寸
- 重新渲染词云

### 5.4 性能优化

**优化策略：**

1. **文本预处理：** 在 Worker 中处理，避免阻塞 UI
2. **防抖处理：** 如果 dynamics 频繁变化，使用防抖
3. **缓存机制：** 相同文本只处理一次
4. **限制词数：** 只显示前 N 个高频词（如 50-100 个）
5. **懒加载：** 只在组件可见时加载和渲染

## 六、兼容性考虑

### 6.1 浏览器支持

- **Web Workers：** 所有现代浏览器支持
- **WebAssembly：** 所有现代浏览器支持（默认所有用户浏览器都支持）
- **Canvas：** 所有浏览器支持

## 七、实现步骤

### 阶段一：基础准备（1-2 小时）

1. ✅ 安装依赖包
2. ✅ 创建文件结构
3. ✅ 实现停用词表和颜色生成器
4. ✅ 实现文本提取函数

### 阶段二：分词功能（2-3 小时）

1. ✅ 研究 jieba-wasm 的使用方法
2. ✅ 实现 Web Worker 脚本
3. ✅ 测试分词功能
4. ✅ 实现停用词过滤和词频统计

### 阶段三：词云渲染（2-3 小时）

1. ✅ 集成 wordcloud2.js
2. ✅ 实现词云组件
3. ✅ 配置颜色、字体、布局
4. ✅ 实现响应式布局

### 阶段四：集成与优化（1-2 小时）

1. ✅ 集成到 Chapter2 组件
2. ✅ 添加加载状态和错误处理
3. ✅ 性能优化
4. ✅ 样式美化

### 阶段五：测试与调试（1-2 小时）

1. ✅ 测试不同数据量
2. ✅ 测试不同浏览器
3. ✅ 修复 bug
4. ✅ 优化用户体验

**总计预估时间：** 7-12 小时

## 八、风险评估

### 8.1 高风险项

1. **jieba-wasm 可用性**

   - **风险：** 可能没有现成的 npm 包
   - **应对：** 准备备选方案（纯 JS 分词库）

2. **Web Worker 模块导入**
   - **风险：** Vite 配置可能复杂
   - **应对：** 使用 importScripts 或 comlink

### 8.2 中风险项

1. **性能问题**
   - **风险：** 大量文本处理可能较慢
   - **应对：** 使用 Worker、限制词数、添加加载提示

## 九、备选方案

### 方案 B：简化版（如果 jieba-wasm 不可用）

1. **分词：** 使用简单的正则表达式分词
2. **词云：** 仍使用 wordcloud2.js
3. **处理：** 在主线程处理（数据量小时可接受）

**注意：** 此方案性能较差，仅在 jieba-wasm 完全不可用时考虑

## 十、推荐方案

**推荐使用方案 A（完整方案），原因：**

1. ✅ 性能最优（WASM + Worker）
2. ✅ 用户体验好（无需后端）
3. ✅ 符合现代前端最佳实践
4. ✅ 所有用户浏览器都支持 WebAssembly

## 十一、后续优化方向

1. **交互功能：** 点击词云词条显示相关动态
2. **动画效果：** 词云渐入动画
3. **自定义配置：** 允许用户调整颜色、字体大小
4. **导出功能：** 导出词云图片
5. **多语言支持：** 支持英文等其他语言分词

---

## 附录：参考资源

- [wordcloud2.js 文档](https://github.com/timdream/wordcloud2.js)
- [jieba-wasm GitHub](https://github.com/yanyiwu/nodejieba)（需要确认是否有 WASM 版本）
- [Web Workers MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API)
- [Vite Worker 支持](https://vitejs.dev/guide/features.html#web-workers)
